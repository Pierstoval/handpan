<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Handpan patterns</title>

    <link rel="stylesheet" type="text/css" href="assets/bootstrap.min.css">
    <style type="text/css">
        body {
            background-color: #292929;
            color: #ddd;
        }
        #pattern .pattern_item {
            position: relative;
            height: 100px;
            display: inline-block;
        }

        /* Handpan hit type text */
        #pattern .pattern_item .inner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: solid 2px #aaa;
            text-align: center;
            line-height: 46px;
            -webkit-border-radius: 50%;
            -moz-border-radius: 50%;
            border-radius: 50%;
            overflow: hidden;
        }

        /* Notes list */
        #pattern .pattern_item .notes {
            position: absolute;
            text-align: center;
            width: 50px;
            margin: 0 15px;
            line-height: 9pt;
            font-size: 9pt;
        }

        /* Lines between each pattern element */
        #pattern .pattern_item:not(:last-of-type)::after,
        #pattern .pattern_item:not(:first-of-type)::before,
        #pattern .pattern_item:first-of-type::before,
        #pattern .pattern_item:last-of-type::after
        {
            content: "—";
            color: #ddd;
            display: inline-block;
            width: 15px;
            margin-top: -15px;
            top: -20px;
            position: relative;
        }
        #pattern .pattern_item:first-of-type::before,
        #pattern .pattern_item:last-of-type::after {
            content: "";
        }

        .pattern_time_separator {
            display: inline-block;
            position: relative;
            top: -18px;
            width: 12px;
            height: 12px;
            background: #aaa;
            -webkit-border-radius: 50%;
            -moz-border-radius: 50%;
            border-radius: 50%;
        }
    </style>
</head>
<body>

<div class="container">

    <form action="#">

        <fieldset class="form-group">
            <div class="row">
                <div class="col-sm-5">
                    <label for="handpan_notes">Number of notes on your handpan (including the ding):</label>
                    <input type="range" id="handpan_notes" class="custom-range" min="9" max="17" step="1" value="9">
                    <div>
                        Current:
                        <strong id="handpan_notes_result">9</strong>
                    </div>
                    (this option is not used for now, but will be in the future)
                </div>
            </div>
        </fieldset>

        <fieldset class="form-group">
            <p>Number of notes in your pattern:</p>

            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" id="pattern_notes_4" class="custom-control-input" name="pattern_notes" value="4">
                <label class="custom-control-label" for="pattern_notes_4">4</label>
            </div>

            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" id="pattern_notes_8" class="custom-control-input" name="pattern_notes" value="8">
                <label class="custom-control-label" for="pattern_notes_8">8</label>
            </div>

            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" id="pattern_notes_16" class="custom-control-input" name="pattern_notes" value="16">
                <label class="custom-control-label" for="pattern_notes_16">16</label>
            </div>
        </fieldset>

        <fieldset class="form-group">
            <button type="button" id="regenerate_button" class="btn btn-primary">
                Regenerate
            </button>
        </fieldset>
    </form>

    <div id="pattern"></div>
</div>

<script type="application/javascript" src="assets/jquery-3.3.1.slim.min.js"></script>
<script type="application/javascript" src="assets/popper.min.js"></script>
<script type="application/javascript" src="assets/bootstrap.min.js"></script>

<script type="application/javascript">

    (function () {

        /**
         * Globals that are used in setup() & update()
         */
        const handpan_notes_input = document.getElementById('handpan_notes');
        const handpan_notes_result_element = document.getElementById('handpan_notes_result');
        const patterns_container = document.getElementById('pattern');
        const number_of_notes_list = document.querySelectorAll('input[name="pattern_notes"]');

        // Reminder of the common chromatic scale in C:
        // C -> C♯ -> D♭ -> D -> D♯ -> E♭ -> E -> E♯/F♭ -> F -> F♯ -> G♭ -> G -> G♯ -> A♭ -> A -> A♯ -> B♭ -> B -> B♯/C♭ -> C

        // Note: the "position" attribute is not used for now, but will be in the future when people will customize their handpan

        const handpan_notes = [
            // <0 => low notes below the handpan
            // 0 => ding
            // 1 => lowest note on the top-part of the handpan
            {"note": "C", "alter": "#", "octave": 3, "position": 0},
            {"note": "G", "alter": "#", "octave": 3, "position": 1},
            {"note": "A", "alter": "",  "octave": 4, "position": 2},
            {"note": "B", "alter": "",  "octave": 4, "position": 3},
            {"note": "C", "alter": "#", "octave": 4, "position": 4},
            {"note": "D", "alter": "#", "octave": 4, "position": 5},
            {"note": "E", "alter": "",  "octave": 4, "position": 6},
            {"note": "F", "alter": "#", "octave": 4, "position": 7},
            {"note": "G", "alter": "#", "octave": 4, "position": 8},
        ];

        const handpan_hits = [
            {"type": 'ding',       "needs_notes": 0},
            {"type": 'slam',       "needs_notes": 0},
            {"type": 'left_slam',  "needs_notes": 0},
            {"type": 'right_slam', "needs_notes": 0},
            {"type": 'ghost',      "needs_notes": 0},
            {"type": 'punch',      "needs_notes": 0},
            {"type": 'any_note',   "needs_notes": 0},
            {"type": 'note',       "needs_notes": 1},
            {"type": 'double',     "needs_notes": 2}, // "power" chord
            {"type": 'triple',     "needs_notes": 3}, // chord
            {"type": 'harmonic',   "needs_notes": 1},
        ];

        // Will help choose random elements from hits or notes
        Array.prototype.randomElement = function () {
            return this[Math.floor(Math.random() * this.length)]
        };

        function setup() {
            handpan_notes_result_element.value = 9;

            number_of_notes_list[1].checked = true;
            for (let pattern_note of number_of_notes_list) {
                pattern_note.addEventListener('change', update);
            }

            document.getElementById('regenerate_button').addEventListener('click', update);

            handpan_notes_input.addEventListener('input', update);
        }

        /**
         * @param event Event
         */
        function update(event) {
            const handpan_notes = handpan_notes_input.value;
            const number_of_notes_in_pattern = getRadioButtonValue(number_of_notes_list);

            handpan_notes_result_element.innerText = handpan_notes;

            patterns_container.innerText = '';

            for (let i = 0; i < number_of_notes_in_pattern; i++) {
                let item = createPatternItem();

                patterns_container.appendChild(item);
                if (i && (i + 1) % 4 === 0 && (i + 1) < number_of_notes_in_pattern) {
                    const pattern_item_separator = document.createElement('span');
                    pattern_item_separator.className = 'pattern_time_separator';
                    patterns_container.appendChild(pattern_item_separator);
                }
            }
        }

        function createPatternItem() {
            const pattern_item = document.createElement('div');
            pattern_item.className = 'pattern_item';

            // Choose a "hit" type randomly in the list
            const handpan_hit = handpan_hits.randomElement();

            // Display handpan hit type
            const text_element = document.createElement('span');
            text_element.className = 'inner';
            text_element.innerText = handpan_hit.type;
            pattern_item.appendChild(text_element);

            // Handle potential notes to display if necessary
            if (handpan_hit.needs_notes) {
                const notes_element = document.createElement('div');
                notes_element.className = 'notes';

                // Choose as many random note in the list so we can display them as a helper
                const notes = [];

                for (let i = 0; i < handpan_hit.needs_notes; i++) {
                    // Pick a random note
                    const note = handpan_notes.randomElement();
                    notes.push(note.note + note.alter + note.octave);
                }

                notes_element.innerHTML = notes.join('<br>');

                pattern_item.appendChild(notes_element);
            }

            return pattern_item;
        }

        function getRadioButtonValue(radios_list) {
            for (let item of radios_list) {
                if (item.checked) {
                    return item.value;
                }
            }

            return null;
        }

        setup();
        update();

    })();

</script>

</body>
</html>
